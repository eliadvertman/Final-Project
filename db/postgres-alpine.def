Bootstrap: docker
From: postgres:alpine

%post
    # Remove privileged startup scripts that cause ownership issues
    rm -f /usr/local/bin/docker-entrypoint.sh
    
    # Create minimal required directories
    mkdir -p /var/lib/postgresql/data
    mkdir -p /var/run/postgresql

%environment
    export POSTGRES_DB=pic_db
    export POSTGRES_USER=pic_user
    export POSTGRES_PASSWORD=pic_password
    export PGDATA=/var/lib/postgresql/data

%runscript
    # Initialize database if not exists (as current user)
    if [ ! -f "$PGDATA/PG_VERSION" ]; then
        echo "Initializing PostgreSQL database..."
        initdb -D "$PGDATA" --auth-host=trust --no-locale --encoding=UTF8
        
        # Configure for external connections
        echo "host all all 0.0.0.0/0 trust" >> "$PGDATA/pg_hba.conf"
        echo "listen_addresses = '*'" >> "$PGDATA/postgresql.conf"
        echo "port = 5432" >> "$PGDATA/postgresql.conf"
    fi
    
    # Start PostgreSQL directly (no user switching)
    echo "Starting PostgreSQL..."
    exec postgres -D "$PGDATA"

%labels
    Author PIC Project
    Version 2.0-Alpine
    Description Lean PostgreSQL Alpine container without privilege escalation