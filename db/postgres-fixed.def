Bootstrap: docker
From: postgres:15

%environment
    export POSTGRES_DB=pic_db
    export POSTGRES_USER=pic_user
    export POSTGRES_PASSWORD=pic_password

%post
    # Create necessary directories
    mkdir -p /var/lib/postgresql/data
    mkdir -p /docker-entrypoint-initdb.d

%runscript
    # Check if data directory is provided as bind mount
    if [ -n "$PGDATA" ]; then
        export PGDATA="$PGDATA"
    else
        export PGDATA="/var/lib/postgresql/data"
    fi
    
    # Ensure proper ownership (works with --fakeroot)
    chown -R postgres:postgres /var/lib/postgresql
    chmod 700 "$PGDATA"
    
    # Initialize database if not exists
    if [ ! -f "$PGDATA/PG_VERSION" ]; then
        echo "Initializing PostgreSQL database..."
        runuser -u postgres -- initdb -D "$PGDATA"
        
        # Start PostgreSQL temporarily to create user and database
        runuser -u postgres -- postgres -D "$PGDATA" &
        PG_PID=$!
        sleep 5
        
        # Create database and user
        runuser -u postgres -- createdb "$POSTGRES_DB" 2>/dev/null || true
        runuser -u postgres -- psql -c "CREATE USER $POSTGRES_USER WITH PASSWORD '$POSTGRES_PASSWORD';" 2>/dev/null || true
        runuser -u postgres -- psql -c "GRANT ALL PRIVILEGES ON DATABASE $POSTGRES_DB TO $POSTGRES_USER;" 2>/dev/null || true
        
        # Stop temporary PostgreSQL
        kill $PG_PID
        wait $PG_PID
    fi
    
    # Start PostgreSQL
    echo "Starting PostgreSQL..."
    exec runuser -u postgres -- postgres -D "$PGDATA"

%labels
    Author PIC Project
    Version 1.0
    Description PostgreSQL database for PIC project